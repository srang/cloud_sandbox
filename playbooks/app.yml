#!/usr/bin/env ansible-playbook
- name: build application
  hosts: master
  vars:
    git_dir: /opt/camel
    git_repo: https://github.com/srang/cloud_camel.git
  become: True
  tasks:

    - name: create project dir
      file:
        path: "{{ git_dir }}"
        state: directory
        owner: vagrant
        mode: 0755

    - name: clone projects
      become: no
      git:
        clone: yes
        force: yes
        version: master
        repo: "{{ git_repo }}"
        dest: "{{ git_dir }}"

    - name: install maven
      yum:
        name: maven
        state: installed

    - name: build project
      become: no
      command: "mvn clean install -f {{ git_dir }}/pom.xml"


- name: set up app servers
  hosts: appservers
  become: True
  vars:
    git_dir: /opt/camel
    app_port: 80
  tasks:

    - name: create spring user
      user:
        name: spring
        shell: /sbin/nologin
        state: present

    - name: copy jar from master to app servers
      copy:
        src: "{{ git_dir }}/target/app.jar"
        dest: /opt
        owner: spring
        mode: 0100

    - name: set up systemd service
      copy:
        src: ../files/boot.service
        dest: /etc/systemd/system
      notify: restart boot

    - name: install java
      yum:
        name: java
        state: installed
      notify: restart boot

  handlers:
    - name: restart boot
      environment:
        APP_PORT: "{{ app_port }}"
        DB_HOST: localhost
        DB_PORT: "{{ app_port }}"
        DB_CONTEXT: "/data"
      service:
        name:boot
        state: restarted
